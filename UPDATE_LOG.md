# 家庭点餐小程序 - 功能更新说明

## 已完成的功能

### 1. 菜品分类功能 ✅
- **后端实现**：
  - 在 `dish` 表中添加 `category` 字段（肉类、蔬菜、主食、凉菜、汤）
  - 更新了 `Dish` 实体类、`DishDTO` 和 `DishMapper.xml`
  - 数据库初始化脚本包含示例分类数据

- **前端实现**：
  - 菜品列表页新增分类标签筛选功能
  - 支持按分类筛选菜品
  - 添加菜品页面新增分类选择器（5个分类可选）

### 2. 界面布局优化 ✅
- **已点次数位置调整**：
  - 从原来的价格旁边移到了备注下方
  - 避免了与添加按钮重叠的问题
  - 界面更加清晰美观

### 3. 微信授权登录 ✅
- **后端实现**：
  - 创建 `user` 表存储用户信息（openid、uuid、昵称、头像、角色）
  - 实现 `UserService` 和 `UserController`
  - 提供微信登录接口 `/user/wxLogin`
  - 提供管理员检查接口 `/user/checkAdmin`

- **前端实现**：
  - App启动时自动调用微信登录
  - 创建 `userManager` 工具管理用户信息
  - 用户信息本地缓存

### 4. 基于UUID的权限控制 ✅
- **管理员权限**：
  - 只有管理员才能看到首页的悬浮"+"按钮（添加菜品）
  - 只有管理员才能访问添加菜品页面
  - 只有管理员才能看到订单的"确认"和"删除"按钮
  
- **普通用户权限**：
  - 可以浏览菜品、添加到购物车
  - 可以提交订单，提交后显示"等待老公确认"
  - 可以查看自己的订单列表
  - 订单提交后自动跳转到订单列表页

## 配置说明

### 后端配置
在 `application.properties` 中需要配置：

```properties
# 微信小程序配置
wx.appid=wxe17c8a6b5b7ff823
wx.secret=YOUR_APP_SECRET          # 需要填写真实的小程序密钥
```

### 设置管理员的步骤：

权限控制完全基于数据库的 `role` 字段，支持多个管理员：

1. **第一次登录**：用户登录后，系统会自动在 `user` 表中创建记录

2. **设置管理员**：在数据库中执行：
   ```sql
   -- 查看所有用户
   SELECT id, openid, uuid, nickname, role FROM user;
   
   -- 将指定用户设置为管理员（role=1）
   UPDATE user SET role = 1 WHERE openid = '你的openid';
   
   -- 或者按ID设置
   UPDATE user SET role = 1 WHERE id = 1;
   ```

3. **取消管理员**：
   ```sql
   UPDATE user SET role = 0 WHERE openid = '某个openid';
   ```

4. **刷新小程序**：重新编译小程序，管理员就能看到管理功能了

## 数据库更新

需要重新运行数据库初始化脚本 `init.sql`，该脚本已包含：
- 新增的 `user` 表
- 更新的 `dish` 表（添加了 `category` 字段）
- 更新的示例数据（包含分类信息）

## 测试流程

### 1. 普通用户流程
1. 打开小程序，自动登录
2. 浏览菜品列表，可以按分类筛选
3. 点击菜品查看详情
4. 添加菜品到购物车
5. 在购物车页面提交订单
6. 提交后显示"等待老公确认"，跳转到订单列表
7. 在订单列表中只能查看订单，看不到确认/删除按钮

### 2. 管理员流程
1. 配置管理员UUID后重启后端
2. 使用管理员账号登录小程序
3. 在首页看到右下角悬浮的"+"按钮
4. 点击"+"可以添加新菜品，需选择分类
5. 在订单列表中可以看到"老公确认"和"删除"按钮
6. 点击"老公确认"将订单状态改为"已许可"
7. 点击"完成订单"将订单状态改为"已完成"

## 技术亮点

1. **权限控制**：基于UUID的灵活权限管理
2. **用户体验**：自动登录，无感知接入
3. **界面优化**：分类标签、悬浮按钮、清晰的布局
4. **角色区分**：不同角色看到不同的功能按钮
5. **可扩展性**：预留了角色字段，可扩展更多权限等级

## 注意事项

1. 首次使用需要配置微信小程序的 AppSecret
2. 需要在微信公众平台开启"不校验合法域名"（开发阶段）
3. 生产环境需要配置服务器域名白名单
4. 管理员UUID需要在用户首次登录后从数据库获取
